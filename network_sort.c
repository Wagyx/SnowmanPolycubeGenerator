#include "network_sort.h"
#include <stdlib.h>

#define COMPARE_SWAP(a, b) {uint16_t x = base[a]; uint16_t y = base[b]; base[a] = x > y ? y : x; base[b] = x > y ? x : y;}

void network_sort(uint16_t* base, int length, int (*compare)(const void*, const void*)) {
	switch(length) {
		case 11:
			network_sort11(base);
			break;
		case 12:
			network_sort12(base);
			break;
		case 13:
			network_sort13(base);
			break;
		case 14:
			network_sort14(base);
			break;
		case 15:
			network_sort15(base);
			break;
		case 16:
			network_sort16(base);
			break;
		case 17:
			network_sort17(base);
			break;
		case 18:
			network_sort18(base);
			break;
		default:
			qsort(base, length, sizeof(uint16_t), compare);
	}
}

// For small numbers of elements, sorting networks turn out to be more efficient than qsort.
// Initial testing shows a 15%-20% speedup in the overall generation performance
// https://www.cs.brandeis.edu/~hugues/sorting_networks.html
// The implementations lower than 16 inputs were developed by simply removing the affected sort lines
// Higher implementations than 16 were built from the data in 
// https://bertdobbelaere.github.io/sorting_networks.html

void network_sort11(uint16_t* base) {
	COMPARE_SWAP(0,1)
	COMPARE_SWAP(2,3)
	COMPARE_SWAP(4,5)
	COMPARE_SWAP(6,7)
	COMPARE_SWAP(8,9)
	//COMPARE_SWAP(10,11)
	//COMPARE_SWAP(12,13)
	//COMPARE_SWAP(14,15)
	
	
	COMPARE_SWAP(0,2)
	COMPARE_SWAP(4,6)
	COMPARE_SWAP(8,10)
	//COMPARE_SWAP(12,14)
	
	COMPARE_SWAP(1,3)
	COMPARE_SWAP(5,7)
	//COMPARE_SWAP(9,11)
	//COMPARE_SWAP(13,15)
	
	
	COMPARE_SWAP(0,4)
	//COMPARE_SWAP(8,12)
	
	COMPARE_SWAP(1,5)
	//COMPARE_SWAP(9,13)
	
	COMPARE_SWAP(2,6)
	//COMPARE_SWAP(10,14)
	
	COMPARE_SWAP(3,7)
	//COMPARE_SWAP(11,15)
	
	
	COMPARE_SWAP(0,8)
	COMPARE_SWAP(1,9)
	COMPARE_SWAP(2,10)
	//COMPARE_SWAP(3,11)
	//COMPARE_SWAP(4,12)
	//COMPARE_SWAP(5,13)
	//COMPARE_SWAP(6,14)
	//COMPARE_SWAP(7,15)
	
	COMPARE_SWAP(5,10)
	COMPARE_SWAP(6,9)
	//COMPARE_SWAP(3,12)
	//COMPARE_SWAP(13,14)
	//COMPARE_SWAP(7,11)
	
	COMPARE_SWAP(1,2)
	COMPARE_SWAP(4,8)
	COMPARE_SWAP(1,4)
	//COMPARE_SWAP(7,13)
	
	COMPARE_SWAP(2,8)
	//COMPARE_SWAP(11,14)
	
	COMPARE_SWAP(2,4)
	COMPARE_SWAP(5,6)
	COMPARE_SWAP(9,10)
	//COMPARE_SWAP(11,13)
	
	COMPARE_SWAP(3,8)
	
	//COMPARE_SWAP(7,12)
	
	COMPARE_SWAP(6,8)
	//COMPARE_SWAP(10,12)
	
	COMPARE_SWAP(3,5)
	COMPARE_SWAP(7,9)
	
	COMPARE_SWAP(3,4)
	COMPARE_SWAP(5,6)
	COMPARE_SWAP(7,8)
	COMPARE_SWAP(9,10)
	//COMPARE_SWAP(11,12)
	
	COMPARE_SWAP(6,7)
	COMPARE_SWAP(8,9)
}

void network_sort12(uint16_t* base) {
	COMPARE_SWAP(0,1)
	COMPARE_SWAP(2,3)
	COMPARE_SWAP(4,5)
	COMPARE_SWAP(6,7)
	COMPARE_SWAP(8,9)
	COMPARE_SWAP(10,11)
	//COMPARE_SWAP(12,13)
	//COMPARE_SWAP(14,15)
	
	
	COMPARE_SWAP(0,2)
	COMPARE_SWAP(4,6)
	COMPARE_SWAP(8,10)
	//COMPARE_SWAP(12,14)
	
	COMPARE_SWAP(1,3)
	COMPARE_SWAP(5,7)
	COMPARE_SWAP(9,11)
	//COMPARE_SWAP(13,15)
	
	
	COMPARE_SWAP(0,4)
	//COMPARE_SWAP(8,12)
	
	COMPARE_SWAP(1,5)
	//COMPARE_SWAP(9,13)
	
	COMPARE_SWAP(2,6)
	//COMPARE_SWAP(10,14)
	
	COMPARE_SWAP(3,7)
	//COMPARE_SWAP(11,15)
	
	
	COMPARE_SWAP(0,8)
	COMPARE_SWAP(1,9)
	COMPARE_SWAP(2,10)
	COMPARE_SWAP(3,11)
	//COMPARE_SWAP(4,12)
	//COMPARE_SWAP(5,13)
	//COMPARE_SWAP(6,14)
	//COMPARE_SWAP(7,15)
	
	COMPARE_SWAP(5,10)
	COMPARE_SWAP(6,9)
	//COMPARE_SWAP(3,12)
	//COMPARE_SWAP(13,14)
	COMPARE_SWAP(7,11)
	
	COMPARE_SWAP(1,2)
	COMPARE_SWAP(4,8)
	COMPARE_SWAP(1,4)
	//COMPARE_SWAP(7,13)
	
	COMPARE_SWAP(2,8)
	//COMPARE_SWAP(11,14)
	
	COMPARE_SWAP(2,4)
	COMPARE_SWAP(5,6)
	COMPARE_SWAP(9,10)
	//COMPARE_SWAP(11,13)
	
	COMPARE_SWAP(3,8)
	
	//COMPARE_SWAP(7,12)
	
	COMPARE_SWAP(6,8)
	//COMPARE_SWAP(10,12)
	
	COMPARE_SWAP(3,5)
	COMPARE_SWAP(7,9)
	
	COMPARE_SWAP(3,4)
	COMPARE_SWAP(5,6)
	COMPARE_SWAP(7,8)
	COMPARE_SWAP(9,10)
	//COMPARE_SWAP(11,12)
	
	COMPARE_SWAP(6,7)
	COMPARE_SWAP(8,9)
}


void network_sort13(uint16_t* base) {
	COMPARE_SWAP(0,1)
	COMPARE_SWAP(2,3)
	COMPARE_SWAP(4,5)
	COMPARE_SWAP(6,7)
	COMPARE_SWAP(8,9)
	COMPARE_SWAP(10,11)
	//COMPARE_SWAP(12,13)
	//COMPARE_SWAP(14,15)
	
	
	COMPARE_SWAP(0,2)
	COMPARE_SWAP(4,6)
	COMPARE_SWAP(8,10)
	//COMPARE_SWAP(12,14)
	
	COMPARE_SWAP(1,3)
	COMPARE_SWAP(5,7)
	COMPARE_SWAP(9,11)
	//COMPARE_SWAP(13,15)
	
	
	COMPARE_SWAP(0,4)
	COMPARE_SWAP(8,12)
	
	COMPARE_SWAP(1,5)
	//COMPARE_SWAP(9,13)
	
	COMPARE_SWAP(2,6)
	//COMPARE_SWAP(10,14)
	
	COMPARE_SWAP(3,7)
	//COMPARE_SWAP(11,15)
	
	
	COMPARE_SWAP(0,8)
	COMPARE_SWAP(1,9)
	COMPARE_SWAP(2,10)
	COMPARE_SWAP(3,11)
	COMPARE_SWAP(4,12)
	//COMPARE_SWAP(5,13)
	//COMPARE_SWAP(6,14)
	//COMPARE_SWAP(7,15)
	
	COMPARE_SWAP(5,10)
	COMPARE_SWAP(6,9)
	COMPARE_SWAP(3,12)
	//COMPARE_SWAP(13,14)
	COMPARE_SWAP(7,11)
	
	COMPARE_SWAP(1,2)
	COMPARE_SWAP(4,8)
	COMPARE_SWAP(1,4)
	//COMPARE_SWAP(7,13)
	
	COMPARE_SWAP(2,8)
	//COMPARE_SWAP(11,14)
	
	COMPARE_SWAP(2,4)
	COMPARE_SWAP(5,6)
	COMPARE_SWAP(9,10)
	//COMPARE_SWAP(11,13)
	
	COMPARE_SWAP(3,8)
	
	COMPARE_SWAP(7,12)
	
	COMPARE_SWAP(6,8)
	COMPARE_SWAP(10,12)
	
	COMPARE_SWAP(3,5)
	COMPARE_SWAP(7,9)
	
	COMPARE_SWAP(3,4)
	COMPARE_SWAP(5,6)
	COMPARE_SWAP(7,8)
	COMPARE_SWAP(9,10)
	COMPARE_SWAP(11,12)
	
	COMPARE_SWAP(6,7)
	COMPARE_SWAP(8,9)
}

void network_sort14(uint16_t* base) {
	COMPARE_SWAP(0,1)
	COMPARE_SWAP(2,3)
	COMPARE_SWAP(4,5)
	COMPARE_SWAP(6,7)
	COMPARE_SWAP(8,9)
	COMPARE_SWAP(10,11)
	COMPARE_SWAP(12,13)
	//COMPARE_SWAP(14,15)
	
	
	COMPARE_SWAP(0,2)
	COMPARE_SWAP(4,6)
	COMPARE_SWAP(8,10)
	//COMPARE_SWAP(12,14)
	
	COMPARE_SWAP(1,3)
	COMPARE_SWAP(5,7)
	COMPARE_SWAP(9,11)
	//COMPARE_SWAP(13,15)
	
	
	COMPARE_SWAP(0,4)
	COMPARE_SWAP(8,12)
	
	COMPARE_SWAP(1,5)
	COMPARE_SWAP(9,13)
	
	COMPARE_SWAP(2,6)
	//COMPARE_SWAP(10,14)
	
	COMPARE_SWAP(3,7)
	//COMPARE_SWAP(11,15)
	
	
	COMPARE_SWAP(0,8)
	COMPARE_SWAP(1,9)
	COMPARE_SWAP(2,10)
	COMPARE_SWAP(3,11)
	COMPARE_SWAP(4,12)
	COMPARE_SWAP(5,13)
	//COMPARE_SWAP(6,14)
	//COMPARE_SWAP(7,15)
	
	COMPARE_SWAP(5,10)
	COMPARE_SWAP(6,9)
	COMPARE_SWAP(3,12)
	//COMPARE_SWAP(13,14)
	COMPARE_SWAP(7,11)
	
	COMPARE_SWAP(1,2)
	COMPARE_SWAP(4,8)
	COMPARE_SWAP(1,4)
	COMPARE_SWAP(7,13)
	
	COMPARE_SWAP(2,8)
	//COMPARE_SWAP(11,14)
	
	COMPARE_SWAP(2,4)
	COMPARE_SWAP(5,6)
	COMPARE_SWAP(9,10)
	COMPARE_SWAP(11,13)
	
	COMPARE_SWAP(3,8)
	
	COMPARE_SWAP(7,12)
	
	COMPARE_SWAP(6,8)
	COMPARE_SWAP(10,12)
	
	COMPARE_SWAP(3,5)
	COMPARE_SWAP(7,9)
	
	COMPARE_SWAP(3,4)
	COMPARE_SWAP(5,6)
	COMPARE_SWAP(7,8)
	COMPARE_SWAP(9,10)
	COMPARE_SWAP(11,12)
	
	COMPARE_SWAP(6,7)
	COMPARE_SWAP(8,9)
}


void network_sort15(uint16_t* base) {
	COMPARE_SWAP(0,1)
	COMPARE_SWAP(2,3)
	COMPARE_SWAP(4,5)
	COMPARE_SWAP(6,7)
	COMPARE_SWAP(8,9)
	COMPARE_SWAP(10,11)
	COMPARE_SWAP(12,13)
	//COMPARE_SWAP(14,15)
	
	
	COMPARE_SWAP(0,2)
	COMPARE_SWAP(4,6)
	COMPARE_SWAP(8,10)
	COMPARE_SWAP(12,14)
	
	COMPARE_SWAP(1,3)
	COMPARE_SWAP(5,7)
	COMPARE_SWAP(9,11)
	//COMPARE_SWAP(13,15)
	
	
	COMPARE_SWAP(0,4)
	COMPARE_SWAP(8,12)
	
	COMPARE_SWAP(1,5)
	COMPARE_SWAP(9,13)
	
	COMPARE_SWAP(2,6)
	COMPARE_SWAP(10,14)
	
	COMPARE_SWAP(3,7)
	//COMPARE_SWAP(11,15)
	
	
	COMPARE_SWAP(0,8)
	COMPARE_SWAP(1,9)
	COMPARE_SWAP(2,10)
	COMPARE_SWAP(3,11)
	COMPARE_SWAP(4,12)
	COMPARE_SWAP(5,13)
	COMPARE_SWAP(6,14)
	//COMPARE_SWAP(7,15)
	
	COMPARE_SWAP(5,10)
	COMPARE_SWAP(6,9)
	COMPARE_SWAP(3,12)
	COMPARE_SWAP(13,14)
	COMPARE_SWAP(7,11)
	
	COMPARE_SWAP(1,2)
	COMPARE_SWAP(4,8)
	COMPARE_SWAP(1,4)
	COMPARE_SWAP(7,13)
	
	COMPARE_SWAP(2,8)
	COMPARE_SWAP(11,14)
	
	COMPARE_SWAP(2,4)
	COMPARE_SWAP(5,6)
	COMPARE_SWAP(9,10)
	COMPARE_SWAP(11,13)
	
	COMPARE_SWAP(3,8)
	
	COMPARE_SWAP(7,12)
	
	COMPARE_SWAP(6,8)
	COMPARE_SWAP(10,12)
	
	COMPARE_SWAP(3,5)
	COMPARE_SWAP(7,9)
	
	COMPARE_SWAP(3,4)
	COMPARE_SWAP(5,6)
	COMPARE_SWAP(7,8)
	COMPARE_SWAP(9,10)
	COMPARE_SWAP(11,12)
	
	COMPARE_SWAP(6,7)
	COMPARE_SWAP(8,9)
}

void network_sort16(uint16_t* base) {
	COMPARE_SWAP(0,1)
	COMPARE_SWAP(2,3)
	COMPARE_SWAP(4,5)
	COMPARE_SWAP(6,7)
	COMPARE_SWAP(8,9)
	COMPARE_SWAP(10,11)
	COMPARE_SWAP(12,13)
	COMPARE_SWAP(14,15)
	
	
	COMPARE_SWAP(0,2)
	COMPARE_SWAP(4,6)
	COMPARE_SWAP(8,10)
	COMPARE_SWAP(12,14)
	
	COMPARE_SWAP(1,3)
	COMPARE_SWAP(5,7)
	COMPARE_SWAP(9,11)
	COMPARE_SWAP(13,15)
	
	
	COMPARE_SWAP(0,4)
	COMPARE_SWAP(8,12)
	
	COMPARE_SWAP(1,5)
	COMPARE_SWAP(9,13)
	
	COMPARE_SWAP(2,6)
	COMPARE_SWAP(10,14)
	
	COMPARE_SWAP(3,7)
	COMPARE_SWAP(11,15)
	
	
	COMPARE_SWAP(0,8)
	COMPARE_SWAP(1,9)
	COMPARE_SWAP(2,10)
	COMPARE_SWAP(3,11)
	COMPARE_SWAP(4,12)
	COMPARE_SWAP(5,13)
	COMPARE_SWAP(6,14)
	COMPARE_SWAP(7,15)
	
	COMPARE_SWAP(5,10)
	COMPARE_SWAP(6,9)
	COMPARE_SWAP(3,12)
	COMPARE_SWAP(13,14)
	COMPARE_SWAP(7,11)
	
	COMPARE_SWAP(1,2)
	COMPARE_SWAP(4,8)
	COMPARE_SWAP(1,4)
	COMPARE_SWAP(7,13)
	
	COMPARE_SWAP(2,8)
	COMPARE_SWAP(11,14)
	
	COMPARE_SWAP(2,4)
	COMPARE_SWAP(5,6)
	COMPARE_SWAP(9,10)
	COMPARE_SWAP(11,13)
	
	COMPARE_SWAP(3,8)
	
	COMPARE_SWAP(7,12)
	
	COMPARE_SWAP(6,8)
	COMPARE_SWAP(10,12)
	
	COMPARE_SWAP(3,5)
	COMPARE_SWAP(7,9)
	
	COMPARE_SWAP(3,4)
	COMPARE_SWAP(5,6)
	COMPARE_SWAP(7,8)
	COMPARE_SWAP(9,10)
	COMPARE_SWAP(11,12)
	
	COMPARE_SWAP(6,7)
	COMPARE_SWAP(8,9)
}

void network_sort17(uint16_t* base) {
	COMPARE_SWAP(0, 11)
	COMPARE_SWAP(1, 15)
	COMPARE_SWAP(2, 10)
	COMPARE_SWAP(3, 5)
	COMPARE_SWAP(4, 6)
	COMPARE_SWAP(8, 12)
	COMPARE_SWAP(9, 16)
	COMPARE_SWAP(13, 14)
	COMPARE_SWAP(0, 6)
	COMPARE_SWAP(1, 13)
	COMPARE_SWAP(2, 8)
	COMPARE_SWAP(4, 14)
	COMPARE_SWAP(5, 15)
	COMPARE_SWAP(7, 11)
	COMPARE_SWAP(0, 8)
	COMPARE_SWAP(3, 7)
	COMPARE_SWAP(4, 9)
	COMPARE_SWAP(6, 16)
	COMPARE_SWAP(10, 11)
	COMPARE_SWAP(12, 14)
	COMPARE_SWAP(0, 2)
	COMPARE_SWAP(1, 4)
	COMPARE_SWAP(5, 6)
	COMPARE_SWAP(7, 13)
	COMPARE_SWAP(8, 9)
	COMPARE_SWAP(10, 12)
	COMPARE_SWAP(11, 14)
	COMPARE_SWAP(15, 16)
	COMPARE_SWAP(0, 3)
	COMPARE_SWAP(2, 5)
	COMPARE_SWAP(6, 11)
	COMPARE_SWAP(7, 10)
	COMPARE_SWAP(9, 13)
	COMPARE_SWAP(12, 15)
	COMPARE_SWAP(14, 16)
	COMPARE_SWAP(0, 1)
	COMPARE_SWAP(3, 4)
	COMPARE_SWAP(5, 10)
	COMPARE_SWAP(6, 9)
	COMPARE_SWAP(7, 8)
	COMPARE_SWAP(11, 15)
	COMPARE_SWAP(13, 14)
	COMPARE_SWAP(1, 2)
	COMPARE_SWAP(3, 7)
	COMPARE_SWAP(4, 8)
	COMPARE_SWAP(6, 12)
	COMPARE_SWAP(11, 13)
	COMPARE_SWAP(14, 15)
	COMPARE_SWAP(1, 3)
	COMPARE_SWAP(2, 7)
	COMPARE_SWAP(4, 5)
	COMPARE_SWAP(9, 11)
	COMPARE_SWAP(10, 12)
	COMPARE_SWAP(13, 14)
	COMPARE_SWAP(2, 3)
	COMPARE_SWAP(4, 6)
	COMPARE_SWAP(5, 7)
	COMPARE_SWAP(8, 10)
	COMPARE_SWAP(3, 4)
	COMPARE_SWAP(6, 8)
	COMPARE_SWAP(7, 9)
	COMPARE_SWAP(10, 12)
	COMPARE_SWAP(5, 6)
	COMPARE_SWAP(7, 8)
	COMPARE_SWAP(9, 10)
	COMPARE_SWAP(11, 12)
	COMPARE_SWAP(4, 5)
	COMPARE_SWAP(6, 7)
	COMPARE_SWAP(8, 9)
	COMPARE_SWAP(10, 11)
	COMPARE_SWAP(12, 13)
}

void network_sort18(uint16_t* base) {
	COMPARE_SWAP(0, 1)
	COMPARE_SWAP(2, 3)
	COMPARE_SWAP(4, 5)
	COMPARE_SWAP(6, 7)
	COMPARE_SWAP(8, 9)
	COMPARE_SWAP(10, 11)
	COMPARE_SWAP(12, 13)
	COMPARE_SWAP(14, 15)
	COMPARE_SWAP(16, 17)
	COMPARE_SWAP(0, 2)
	COMPARE_SWAP(1, 3)
	COMPARE_SWAP(4, 12)
	COMPARE_SWAP(5, 13)
	COMPARE_SWAP(6, 8)
	COMPARE_SWAP(9, 11)
	COMPARE_SWAP(14, 16)
	COMPARE_SWAP(15, 17)
	COMPARE_SWAP(0, 14)
	COMPARE_SWAP(1, 16)
	COMPARE_SWAP(2, 15)
	COMPARE_SWAP(3, 17)
	COMPARE_SWAP(0, 6)
	COMPARE_SWAP(1, 10)
	COMPARE_SWAP(2, 9)
	COMPARE_SWAP(7, 16)
	COMPARE_SWAP(8, 15)
	COMPARE_SWAP(11, 17)
	COMPARE_SWAP(1, 4)
	COMPARE_SWAP(3, 9)
	COMPARE_SWAP(5, 7)
	COMPARE_SWAP(8, 14)
	COMPARE_SWAP(10, 12)
	COMPARE_SWAP(13, 16)
	COMPARE_SWAP(0, 1)
	COMPARE_SWAP(2, 5)
	COMPARE_SWAP(3, 13)
	COMPARE_SWAP(4, 14)
	COMPARE_SWAP(7, 9)
	COMPARE_SWAP(8, 10)
	COMPARE_SWAP(12, 15)
	COMPARE_SWAP(16, 17)
	COMPARE_SWAP(1, 2)
	COMPARE_SWAP(3, 5)
	COMPARE_SWAP(4, 6)
	COMPARE_SWAP(11, 13)
	COMPARE_SWAP(12, 14)
	COMPARE_SWAP(15, 16)
	COMPARE_SWAP(4, 8)
	COMPARE_SWAP(5, 12)
	COMPARE_SWAP(6, 10)
	COMPARE_SWAP(7, 11)
	COMPARE_SWAP(9, 13)
	COMPARE_SWAP(1, 4)
	COMPARE_SWAP(2, 8)
	COMPARE_SWAP(3, 6)
	COMPARE_SWAP(5, 7)
	COMPARE_SWAP(9, 15)
	COMPARE_SWAP(10, 12)
	COMPARE_SWAP(11, 14)
	COMPARE_SWAP(13, 16)
	COMPARE_SWAP(2, 4)
	COMPARE_SWAP(5, 8)
	COMPARE_SWAP(6, 10)
	COMPARE_SWAP(7, 11)
	COMPARE_SWAP(9, 12)
	COMPARE_SWAP(13, 15)
	COMPARE_SWAP(3, 5)
	COMPARE_SWAP(6, 8)
	COMPARE_SWAP(7, 10)
	COMPARE_SWAP(9, 11)
	COMPARE_SWAP(12, 14)
	COMPARE_SWAP(3, 4)
	COMPARE_SWAP(5, 6)
	COMPARE_SWAP(7, 8)
	COMPARE_SWAP(9, 10)
	COMPARE_SWAP(11, 12)
	COMPARE_SWAP(13, 14)

}
